# 小红花小程序 - 微信云托管部署指南

## 📋 目录
1. [准备工作](#准备工作)
2. [开通云托管](#开通云托管)
3. [构建镜像](#构建镜像)
4. [部署服务](#部署服务)
5. [配置数据库](#配置数据库)
6. [配置域名](#配置域名)
7. [测试验证](#测试验证)
8. [常见问题](#常见问题)

---

## 📦 准备工作

### 1. 确认已有内容
- ✅ 小程序 AppID：`wxe1fef2b88d7ea01e`
- ✅ 后端代码已完成
- ✅ 本地测试通过
- ✅ Dockerfile 已创建

### 2. 需要准备的账号
- 微信小程序管理员账号
- 能够登录 [微信公众平台](https://mp.weixin.qq.com/)

---

## 🚀 开通云托管

### 步骤 1：进入云托管

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入您的小程序后台
3. 左侧菜单：**云开发** → **云托管**
4. 如果第一次使用，点击**立即开通**

### 步骤 2：开通流程

1. **同意协议**
   - 阅读《微信云托管服务协议》
   - 勾选同意并点击**下一步**

2. **创建环境**
   - 环境名称：`xiaohonghua-prod`（生产环境）
   - 地域选择：**上海**（推荐，延迟低）
   - 点击**创建**

3. **等待开通**
   - 开通需要 1-3 分钟
   - 开通成功后会显示环境信息

---

## 🔨 构建镜像

### 方式一：使用微信开发者工具（推荐，最简单）

#### 1. 打开开发者工具

```bash
# 打开微信开发者工具
# 选择「云开发」→「云托管」
```

#### 2. 创建服务

1. 在云托管界面点击**新建服务**
2. 填写服务信息：
   - 服务名称：`xiaohonghua-backend`
   - 服务说明：`小红花后端服务`
   - 点击**确定**

#### 3. 上传代码

1. 点击**上传代码**
2. 选择代码目录：`/Users/xila/xiaohonghua/backend`
3. 等待自动构建镜像（约 3-10 分钟）

---

### 方式二：使用命令行（高级）

#### 前置要求

1. **安装 Docker**
   ```bash
   # macOS 用户
   brew install --cask docker
   # 或从官网下载：https://www.docker.com/products/docker-desktop
   ```

2. **安装微信云托管 CLI**
   ```bash
   npm install -g @wxcloud/cli
   ```

#### 构建步骤

```bash
# 1. 进入后端目录
cd /Users/xila/xiaohonghua/backend

# 2. 打包 Spring Boot 应用
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH
mvn clean package -DskipTests

# 3. 构建 Docker 镜像
docker build -t xiaohonghua-backend:1.0.0 .

# 4. 测试镜像（可选）
docker run -p 8080:8080 \
  -e MYSQL_ADDRESS="localhost:3306" \
  -e MYSQL_DATABASE="xiaohonghua" \
  -e MYSQL_USERNAME="xiaohonghua" \
  -e MYSQL_PASSWORD="soitsyou" \
  xiaohonghua-backend:1.0.0

# 5. 推送到云托管
wxcloud login  # 先登录
wxcloud deploy --service xiaohonghua-backend --version 1.0.0
```

---

## 💾 配置数据库

### 步骤 1：开通云数据库

1. 在云托管控制台
2. 点击**数据库** → **开通云数据库**
3. 选择配置：
   - 数据库类型：**MySQL 5.7** 或 **MySQL 8.0**
   - 规格：**1核2G**（可按需调整）
   - 存储：**20GB**（可按需调整）

### 步骤 2：初始化数据库

#### 方法A：通过云托管自动执行（推荐）

1. 在服务配置中添加数据库初始化脚本
2. 上传 `sql/schema.sql` 和 `sql/seed.sql`
3. 云托管会在首次部署时自动执行

#### 方法B：手动执行 SQL

1. **下载 SQL 客户端工具**
   - 推荐：Navicat、DBeaver、MySQL Workbench

2. **获取数据库连接信息**
   - 在云托管控制台 → 数据库 → 连接信息
   - 复制：主机地址、端口、用户名、密码

3. **连接并执行 SQL**
   ```bash
   # 使用命令行连接（或使用 GUI 工具）
   mysql -h <云数据库地址> -P 3306 -u <用户名> -p
   
   # 执行建表脚本
   source /Users/xila/xiaohonghua/backend/sql/schema.sql
   
   # 执行初始数据脚本
   source /Users/xila/xiaohonghua/backend/sql/seed.sql
   ```

### 步骤 3：配置环境变量

在云托管控制台 → 服务配置 → 环境变量，添加：

| 环境变量名 | 值 | 说明 |
|-----------|-----|------|
| `MYSQL_ADDRESS` | `xxx.mysql.tencentcdb.com:3306` | 云托管自动注入 |
| `MYSQL_DATABASE` | `xiaohonghua` | 数据库名 |
| `MYSQL_USERNAME` | `root` 或其他 | 云托管自动注入 |
| `MYSQL_PASSWORD` | `******` | 云托管自动注入 |
| `WECHAT_APPID` | `wxe1fef2b88d7ea01e` | 小程序AppID |
| `WECHAT_SECRET` | `b3364978955119ad09d507afe5fc6c1e` | 小程序AppSecret |

⚠️ **注意**：云托管会自动注入 MySQL 相关环境变量，通常只需配置微信相关的。

---

## 🌐 配置域名

### 步骤 1：获取云托管域名

部署成功后，云托管会自动分配一个默认域名，格式如：

```
https://xiaohonghua-backend-1g2xxxxx.sh.run.tcloudbase.com
```

### 步骤 2：配置到微信公众平台

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入：**开发** → **开发管理** → **开发设置** → **服务器域名**
3. 配置以下域名：

| 类型 | 域名 |
|-----|------|
| **request合法域名** | `https://xiaohonghua-backend-1g2xxxxx.sh.run.tcloudbase.com` |
| **uploadFile合法域名** | `https://xiaohonghua-backend-1g2xxxxx.sh.run.tcloudbase.com` |
| **downloadFile合法域名** | `https://xiaohonghua-backend-1g2xxxxx.sh.run.tcloudbase.com` |

4. 点击**保存并提交**

⚠️ **重要提示**：
- 每月只能修改 **5次**，请确认无误后保存
- 云托管域名已自动支持 HTTPS，无需额外配置证书

### 步骤 3：（可选）绑定自定义域名

如果您有自己的域名（如 `api.xiaohonghua.com`）：

1. 在云托管控制台 → 服务设置 → 自定义域名
2. 添加域名：`api.xiaohonghua.com`
3. 按提示添加 CNAME 解析记录
4. 等待 SSL 证书自动签发
5. 使用自定义域名替换默认域名配置到微信公众平台

---

## ✅ 测试验证

### 1. 检查服务状态

在云托管控制台查看：
- ✅ 服务状态：**运行中**
- ✅ 实例数量：**1个或以上**
- ✅ 健康检查：**通过**

### 2. 测试 API 接口

使用浏览器或 curl 测试：

```bash
# 测试健康检查（如果有）
curl https://your-domain.sh.run.tcloudbase.com/api/health

# 测试登录接口
curl -X POST https://your-domain.sh.run.tcloudbase.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code":"test-code"}'

# 测试任务列表（需要先获取 token）
curl https://your-domain.sh.run.tcloudbase.com/api/tasks \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 修改小程序配置

修改 `/Users/xila/xiaohonghua/miniprogram/utils/realApi.js`：

```javascript
const CONFIG = {
  DEV_BASE_URL: 'http://localhost:8081/api',
  PROD_BASE_URL: 'https://your-domain.sh.run.tcloudbase.com/api',  // ← 改为实际云托管域名
  ENV: 'prod'  // ← 改为 prod
}
```

### 4. 测试小程序

1. 在微信开发者工具打开小程序
2. 点击**编译**
3. 测试功能：
   - ✅ 登录功能
   - ✅ 任务列表加载
   - ✅ 积分显示
   - ✅ 奖品兑换
   - ✅ 图片上传

### 5. 查看日志

在云托管控制台 → 日志，查看：
- 请求日志
- 错误日志
- 性能指标

---

## 📊 部署版本管理

### 发布新版本

```bash
# 1. 修改代码后重新打包
cd /Users/xila/xiaohonghua/backend
mvn clean package

# 2. 构建新版本镜像
docker build -t xiaohonghua-backend:1.0.1 .

# 3. 推送到云托管
wxcloud deploy --service xiaohonghua-backend --version 1.0.1

# 4. 在云托管控制台切换到新版本
# 支持灰度发布：先 10% 流量 → 50% → 100%
```

### 回滚版本

如果新版本有问题：
1. 在云托管控制台 → 版本管理
2. 选择上一个稳定版本
3. 点击**切换版本**
4. 流量会立即切回旧版本

---

## 💰 费用说明

### 云托管费用

微信云托管按量计费，费用包括：

| 资源 | 价格（参考） | 说明 |
|-----|-------------|------|
| **容器实例** | ¥0.00008/核秒 | 0.5核 约 ¥12/月 |
| **内存** | ¥0.00001/GB秒 | 1GB 约 ¥26/月 |
| **流量** | ¥0.8/GB | 下行流量 |
| **构建** | 免费 | 每月 1000 分钟 |

**预估成本**（小型应用）：
- 基础费用：约 **¥40-80/月**
- 流量费用：根据实际使用量
- 数据库：1核2G 约 **¥200/月**

**省钱技巧**：
1. 设置自动扩缩容（0 访问时缩到 0 实例）
2. 使用按量计费（不是包年包月）
3. 合理设置资源配额（CPU/内存）

### 免费额度

新用户可享受：
- 容器 CPU：每月免费 **1,000 核秒**
- 容器内存：每月免费 **2,000 GB秒**
- 流量：每月免费 **1GB**

---

## ❓ 常见问题

### 1. 部署失败：镜像构建超时

**原因**：网络问题或依赖下载慢

**解决**：
```dockerfile
# 在 Dockerfile 中添加国内镜像源
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
```

### 2. 服务启动失败：连接数据库超时

**原因**：环境变量未配置或数据库未开通

**检查**：
1. 云托管控制台 → 环境变量
2. 确认 `MYSQL_ADDRESS` 等变量存在
3. 确认云数据库已开通并运行

### 3. 小程序请求失败：request:fail

**原因**：域名未配置到微信公众平台

**解决**：
1. 复制云托管域名
2. 在微信公众平台配置 request 合法域名
3. 重新编译小程序

### 4. 图片上传后无法访问

**原因**：文件存储路径配置问题

**解决方案A**：使用云存储
```yaml
# application-prod.yml
file:
  upload:
    path: /app/uploads/avatars/
```

**解决方案B**：使用对象存储（COS）
- 开通腾讯云 COS
- 修改代码使用 COS SDK 上传
- 返回 COS 外网访问 URL

### 5. 日志在哪里查看？

**查看位置**：
1. 云托管控制台 → 服务详情 → 日志
2. 可以按时间、关键词搜索
3. 支持实时日志流

### 6. 如何调试生产环境问题？

**方法**：
1. **查看日志**：云托管控制台实时日志
2. **临时开启 Swagger**：
   ```yaml
   # application-prod.yml
   knife4j:
     enable: true  # 临时改为 true
   ```
3. **使用云托管终端**：
   - 在控制台进入容器终端
   - 执行命令查看文件、网络等

---

## 🔐 安全建议

### 1. 环境变量安全

✅ **推荐做法**：
- 敏感信息（AppSecret、数据库密码）使用环境变量
- 不要硬编码在代码中
- 不要提交到 Git

❌ **不推荐**：
```java
String appSecret = "b3364978955119ad09d507afe5fc6c1e";  // 硬编码
```

### 2. 数据库安全

- ✅ 使用云托管内网连接数据库
- ✅ 定期备份数据库
- ✅ 限制数据库访问IP白名单

### 3. API 安全

- ✅ 使用 HTTPS（云托管自动支持）
- ✅ 实现请求签名验证
- ✅ 添加请求频率限制
- ✅ 记录访问日志

---

## 📞 相关链接

- **云托管官方文档**：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html
- **微信公众平台**：https://mp.weixin.qq.com/
- **云托管控制台**：https://console.cloud.tencent.com/tcb
- **腾讯云文档**：https://cloud.tencent.com/document/product/1243

---

## ✅ 部署检查清单

部署前确认：

- [ ] 后端代码测试通过
- [ ] Dockerfile 已创建
- [ ] application-prod.yml 配置正确
- [ ] 微信 AppID 和 AppSecret 已准备
- [ ] 云托管已开通
- [ ] 数据库已初始化
- [ ] SQL 脚本已执行
- [ ] 环境变量已配置
- [ ] 域名已配置到微信公众平台
- [ ] 小程序代码已改为 prod 环境
- [ ] API 接口测试通过
- [ ] 小程序功能测试通过

---

**部署完成后，您就可以提交小程序审核了！** 🎉

如有问题，随时查看本文档或咨询微信云托管技术支持。

