# 🎉 小红花小程序 - 云托管部署总结

**创建时间：** 2025-12-23  
**部署方案：** 微信云托管  
**状态：** ✅ 准备就绪，可以开始部署

---

## 📋 准备工作完成清单

### ✅ **后端部署文件已创建**

| 文件 | 位置 | 说明 |
|-----|------|------|
| Dockerfile | `backend/Dockerfile` | Docker 容器化配置 |
| .dockerignore | `backend/.dockerignore` | 优化镜像大小 |
| container.config.json | `backend/container.config.json` | 云托管服务配置 |
| application-prod.yml | `backend/src/main/resources/application-prod.yml` | 生产环境配置 |
| build.sh | `backend/build.sh` | 一键打包脚本 |

### ✅ **部署文档已创建**

| 文档 | 位置 | 用途 |
|-----|------|------|
| 云托管快速开始.md | 项目根目录 | **5分钟快速部署**（推荐） |
| 微信云托管部署指南.md | 项目根目录 | 详细部署文档 |
| 小程序上线检查清单.md | 项目根目录 | 完整上线流程 |

---

## 🚀 快速部署（3步走）

### 第 1️⃣ 步：打包后端（2分钟）

在终端执行：
```bash
cd /Users/xila/xiaohonghua/backend
./build.sh
```

或手动执行：
```bash
cd /Users/xila/xiaohonghua/backend
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH
mvn clean package -DskipTests
```

### 第 2️⃣ 步：上传到云托管（5分钟）

**方法A：微信开发者工具（推荐，最简单）**
1. 打开微信开发者工具
2. 云开发 → 云托管
3. 新建服务：`xiaohonghua-backend`
4. 上传代码，选择目录：`/Users/xila/xiaohonghua/backend`
5. 等待构建完成

**方法B：命令行**
```bash
npm install -g @wxcloud/cli
wxcloud login
wxcloud deploy
```

### 第 3️⃣ 步：配置小程序（1分钟）

1. **获取云托管域名**（部署成功后在控制台查看）
2. **配置到微信公众平台**（服务器域名）
3. **修改小程序代码**：

编辑 `miniprogram/utils/realApi.js`：
```javascript
const CONFIG = {
  DEV_BASE_URL: 'http://localhost:8081/api',
  PROD_BASE_URL: 'https://your-domain.sh.run.tcloudbase.com/api',  // ← 改为云托管域名
  ENV: 'prod'  // ← 改为 prod
}
```

---

## 📊 部署架构

```
┌─────────────────┐
│  微信小程序      │
│  (前端)         │
└────────┬────────┘
         │ HTTPS
         │
         ▼
┌─────────────────────────────┐
│   微信云托管                 │
│  ┌────────────────────────┐ │
│  │ Spring Boot 后端       │ │
│  │ - Java 21              │ │
│  │ - Port 8080            │ │
│  │ - /api/* 接口          │ │
│  └────────┬───────────────┘ │
│           │                  │
│           ▼                  │
│  ┌────────────────────────┐ │
│  │ MySQL 云数据库         │ │
│  │ - 1核2G                │ │
│  │ - 内网连接             │ │
│  └────────────────────────┘ │
└─────────────────────────────┘
```

---

## 💰 预估费用

### 云托管费用（按量计费）
- **容器实例**：0.5核 约 ¥12/月
- **内存**：1GB 约 ¥26/月
- **流量**：¥0.8/GB
- **小计**：约 ¥40-60/月

### 云数据库费用
- **规格**：1核2G
- **费用**：约 ¥200/月

### 总计
- **预估总费用**：¥240-260/月
- **初期免费额度**：新用户可享受一定免费额度

### 省钱技巧
1. 设置自动扩缩容（0实例时不计费）
2. 合理设置资源配额
3. 使用内网连接数据库（免流量费）

---

## 🔑 关键配置说明

### 1. Dockerfile 配置
```dockerfile
# 基础镜像：Java 21 运行时
FROM eclipse-temurin:21-jre-alpine

# 工作目录
WORKDIR /app

# 复制 jar 包
COPY target/xiaohonghua-backend-1.0.0.jar app.jar

# 暴露端口
EXPOSE 8080

# 启动命令
ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

### 2. 生产环境配置
```yaml
# application-prod.yml
server:
  port: 8080  # 云托管默认端口

spring:
  datasource:
    # 云托管自动注入环境变量
    url: jdbc:mysql://${MYSQL_ADDRESS}/${MYSQL_DATABASE}...
    username: ${MYSQL_USERNAME}
    password: ${MYSQL_PASSWORD}

# 微信配置（环境变量）
wechat:
  miniapp:
    appid: ${WECHAT_APPID}
    secret: ${WECHAT_SECRET}
```

### 3. 需要配置的环境变量

在云托管控制台配置：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `WECHAT_APPID` | `wxe1fef2b88d7ea01e` | 小程序AppID |
| `WECHAT_SECRET` | `b3364978955119ad09d507afe5fc6c1e` | 小程序AppSecret |
| `MYSQL_ADDRESS` | 自动注入 | 数据库地址 |
| `MYSQL_DATABASE` | `xiaohonghua` | 数据库名 |
| `MYSQL_USERNAME` | 自动注入 | 数据库用户名 |
| `MYSQL_PASSWORD` | 自动注入 | 数据库密码 |

---

## ✅ 部署后检查

### 1. 检查服务状态
- [ ] 云托管控制台显示"运行中"
- [ ] 实例数量 ≥ 1
- [ ] 健康检查通过

### 2. 测试接口
```bash
# 测试任务列表
curl https://your-domain.sh.run.tcloudbase.com/api/tasks

# 应该返回 JSON 数据
```

### 3. 测试小程序
- [ ] 登录功能正常
- [ ] 任务列表加载成功
- [ ] 积分显示正确
- [ ] 图片上传正常

---

## 📖 相关文档

### 快速上手
1. **云托管快速开始.md** - 5分钟部署指南
2. **微信云托管部署指南.md** - 详细部署文档

### 上线流程
3. **小程序上线检查清单.md** - 完整上线流程

### 官方文档
- [微信云托管文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [微信公众平台](https://mp.weixin.qq.com/)

---

## 🛠️ 常用命令

### 本地开发
```bash
# 启动后端（开发环境）
cd backend
mvn spring-boot:run

# 打包
mvn clean package
```

### 云托管部署
```bash
# 一键打包
cd backend
./build.sh

# 使用 CLI 部署
wxcloud login
wxcloud deploy
```

### 查看日志
```bash
# 云托管 CLI 查看日志
wxcloud logs --service xiaohonghua-backend --tail 100
```

---

## ⚠️ 注意事项

### 部署前必须完成
1. ✅ 后端代码已打包：`target/xiaohonghua-backend-1.0.0.jar`
2. ✅ 云托管已开通
3. ✅ 云数据库已初始化（执行 SQL 脚本）
4. ✅ 环境变量已配置

### 部署后必须完成
1. ✅ 获取云托管域名
2. ✅ 配置到微信公众平台（服务器域名）
3. ✅ 修改小程序代码（ENV = 'prod'）
4. ✅ 测试接口和功能

### 安全建议
- 🔒 不要在代码中硬编码密码和密钥
- 🔒 使用环境变量管理敏感信息
- 🔒 定期备份数据库
- 🔒 监控服务日志和性能

---

## 🎯 下一步行动

### 今天完成（部署）
1. [ ] 阅读《云托管快速开始.md》
2. [ ] 开通微信云托管
3. [ ] 打包并上传后端代码
4. [ ] 配置数据库和环境变量
5. [ ] 测试接口

### 本周完成（上线）
6. [ ] 完善小程序信息（名称、头像、介绍）
7. [ ] 填写用户隐私保护指引
8. [ ] 上传小程序代码
9. [ ] 提交审核
10. [ ] 等待审核通过并发布

---

## 💪 您现在可以：

1. **立即开始部署**
   ```bash
   cd /Users/xila/xiaohonghua/backend
   ./build.sh
   ```

2. **阅读快速指南**
   ```bash
   open /Users/xila/xiaohonghua/云托管快速开始.md
   ```

3. **查看详细文档**
   ```bash
   open /Users/xila/xiaohonghua/微信云托管部署指南.md
   ```

---

**准备就绪，开始部署吧！** 🚀🌸

如有任何问题，随时查看文档或询问！

