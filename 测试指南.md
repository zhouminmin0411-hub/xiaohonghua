# 微信登录功能测试指南

## 📋 测试清单

### 阶段1：环境准备 (3项)
- [ ] 配置微信小程序AppID和AppSecret到application.yml
- [ ] 启动后端服务并确认服务正常运行
- [ ] 创建uploads/avatars目录

### 阶段2：API接口测试 (4项)
- [ ] 测试Mock登录接口
- [ ] 测试微信登录接口
- [ ] 测试更新用户昵称接口
- [ ] 测试上传头像接口

### 阶段3：数据验证测试 (2项)
- [ ] 测试上传超大文件(>2MB)的验证
- [ ] 测试上传不支持文件类型的验证

### 阶段4：数据库验证 (1项)
- [ ] 验证数据库中用户数据正确保存

### 阶段5：前后端联调 (3项)
- [ ] 测试小程序登录流程
- [ ] 测试设置页面修改昵称
- [ ] 测试设置页面更换头像

---

## 🚀 详细测试步骤

### 阶段1：环境准备

#### 步骤1.1：配置微信AppID和AppSecret

**文件位置：** `backend/src/main/resources/application.yml`

**需要修改的内容：**
```yaml
wechat:
  miniapp:
    appid: wx1234567890abcdef  # 替换为真实AppID
    secret: your_real_secret_here  # 替换为真实AppSecret
```

**操作提示：**
- 登录微信公众平台 https://mp.weixin.qq.com
- 进入"开发" -> "开发管理" -> "开发设置"
- 复制AppID和AppSecret

**完成标志：** ✅ AppID和AppSecret已正确配置

---

#### 步骤1.2：启动后端服务

**命令：**
```bash
cd backend
mvn clean spring-boot:run
```

**预期输出：**
```
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.x.x)

...
Started XiaohonghuaApplication in 5.123 seconds
```

**访问测试：**
- Swagger UI: http://localhost:8081/api/doc.html
- 健康检查: http://localhost:8081/api/auth/login (POST)

**完成标志：** ✅ 服务启动成功，Swagger UI可访问

---

#### 步骤1.3：创建上传目录

**命令：**
```bash
cd backend
mkdir -p uploads/avatars
```

**验证：**
```bash
ls -la uploads/avatars
# 应该看到目录已创建
```

**完成标志：** ✅ uploads/avatars目录存在

---

### 阶段2：API接口测试

#### 步骤2.1：测试Mock登录接口

**工具：** 使用Postman或curl

**请求信息：**
```
Method: POST
URL: http://localhost:8081/api/auth/login
Headers:
  Content-Type: application/json
Body:
{
  "openid": "test_openid_001"
}
```

**curl命令：**
```bash
curl -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"openid": "test_openid_001"}'
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "openid": "test_openid_001",
    "role": "child",
    "nickname": "新用户",
    "avatarUrl": "https://thirdwx.qlogo.cn/mmopen/..."
  }
}
```

**记录：** 请记录返回的用户ID：______

**完成标志：** ✅ 返回200状态码，用户创建成功

---

#### 步骤2.2：测试微信登录接口

**注意：** 需要真实的微信code，可以从小程序中获取

**方法A：使用小程序获取真实code**

1. 在小程序中添加临时代码：
```javascript
wx.login({
  success: res => {
    console.log('code:', res.code)
    // 复制这个code用于测试
  }
})
```

2. 使用获取的code测试接口

**方法B：使用Swagger UI测试（推荐）**

1. 访问 http://localhost:8081/api/doc.html
2. 找到"认证接口" -> "微信登录"
3. 点击"Try it out"
4. 输入code（从小程序获取）
5. 点击"Execute"

**curl命令：**
```bash
curl -X POST http://localhost:8081/api/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code": "你的真实code"}'
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 2,
    "openid": "oXXXXXXXXXXXXXXXXXXXXXXXXX",
    "role": "child",
    "nickname": "小朋友"
  }
}
```

**记录：** 请记录返回的用户ID：______

**完成标志：** ✅ 返回200状态码，获取到真实openid

---

#### 步骤2.3：测试更新用户昵称接口

**请求信息：**
```
Method: PUT
URL: http://localhost:8081/api/users/{userId}/profile
Headers:
  Content-Type: application/json
Body:
{
  "nickname": "测试小明"
}
```

**curl命令：**（替换{userId}为实际用户ID）
```bash
curl -X PUT http://localhost:8081/api/users/1/profile \
  -H "Content-Type: application/json" \
  -d '{"nickname": "测试小明"}'
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "nickname": "测试小明",
    ...
  }
}
```

**完成标志：** ✅ 昵称更新成功

---

#### 步骤2.4：测试上传头像接口

**准备：** 准备一张测试图片（jpg/png，小于2MB）

**使用Postman测试：**
```
Method: POST
URL: http://localhost:8081/api/users/1/avatar
Body (form-data):
  Key: avatar (File类型)
  Value: [选择图片文件]
```

**curl命令：**
```bash
curl -X POST http://localhost:8081/api/users/1/avatar \
  -F "avatar=@/path/to/test-avatar.jpg"
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "avatarUrl": "/uploads/avatars/550e8400-e29b-41d4-a716-446655440000.jpg"
  }
}
```

**验证文件是否保存：**
```bash
ls -la backend/uploads/avatars/
# 应该看到刚上传的文件
```

**完成标志：** ✅ 文件上传成功，avatarUrl返回

---

### 阶段3：数据验证测试

#### 步骤3.1：测试上传超大文件

**准备：** 准备一个超过2MB的图片文件

**测试方法：** 使用Postman或curl上传大文件

**预期响应：**
```json
{
  "code": 500,
  "message": "文件大小超过限制（最大2MB）"
}
```

**完成标志：** ✅ 正确拒绝大文件

---

#### 步骤3.2：测试上传不支持的文件类型

**准备：** 准备一个.txt或.pdf文件

**测试方法：** 尝试上传非图片文件

**预期响应：**
```json
{
  "code": 500,
  "message": "不支持的文件类型，只允许：jpg,jpeg,png,gif"
}
```

**完成标志：** ✅ 正确拒绝不支持的文件类型

---

### 阶段4：数据库验证

#### 步骤4.1：验证数据库数据

**连接数据库：**
```bash
mysql -u xiaohonghua -p
# 密码: soitsyou
```

**查询用户数据：**
```sql
USE xiaohonghua;

-- 查看所有用户
SELECT * FROM user;

-- 查看最新用户
SELECT * FROM user ORDER BY created_at DESC LIMIT 3;

-- 验证特定用户
SELECT id, openid, nickname, avatar_url, role, created_at 
FROM user 
WHERE id = 1;
```

**检查项：**
- [ ] openid正确保存
- [ ] nickname已更新
- [ ] avatar_url已更新
- [ ] created_at和updated_at时间正确

**完成标志：** ✅ 数据库数据完整且正确

---

### 阶段5：前后端联调

#### 步骤5.1：测试小程序登录流程

**操作步骤：**

1. 确保后端服务正在运行
2. 在微信开发者工具中打开小程序项目
3. 点击"清除缓存" -> "清除全部缓存"
4. 重新编译运行小程序

**观察点：**
- [ ] 小程序启动时自动触发wx.login
- [ ] 控制台显示"wx.login获取code成功"
- [ ] 后端日志显示收到登录请求
- [ ] 用户信息成功加载到页面

**后端日志应显示：**
```
微信登录请求，code=0x1234567890abcdef
调用微信code2session接口，code=0x1234567890abcdef
微信code2session成功，openid=oXXXXXXXX
```

**完成标志：** ✅ 小程序自动登录成功

---

#### 步骤5.2：测试设置页面修改昵称

**操作步骤：**

1. 在小程序中进入"设置"页面
2. 点击昵称输入框
3. 修改昵称为"测试昵称123"
4. 点击输入框外部（触发失焦保存）

**观察点：**
- [ ] 输入框正常输入
- [ ] 失焦时显示"保存中..."
- [ ] 显示"昵称更新成功"提示
- [ ] 昵称立即更新显示
- [ ] 刷新页面后昵称保持不变

**后端日志应显示：**
```
更新用户资料，userId=1, nickname=测试昵称123
更新用户资料成功，userId=1
```

**完成标志：** ✅ 昵称修改成功且持久化

---

#### 步骤5.3：测试设置页面更换头像

**操作步骤：**

1. 在设置页面点击头像区域
2. 选择"从相册选择"
3. 选择一张图片
4. 等待上传完成

**观察点：**
- [ ] 显示"上传中..."提示
- [ ] 头像立即更新显示
- [ ] 显示"头像更新成功"提示
- [ ] 刷新页面后头像保持不变

**后端日志应显示：**
```
上传用户头像，userId=1, filename=test.jpg
文件上传成功：550e8400-e29b-41d4-a716-446655440000.jpg
上传用户头像成功，userId=1
```

**完成标志：** ✅ 头像上传成功且持久化

---

## 📊 测试结果记录表

### 环境准备
| 项目 | 状态 | 备注 |
|------|------|------|
| AppID配置 | ⬜ | |
| AppSecret配置 | ⬜ | |
| 后端服务启动 | ⬜ | |
| 上传目录创建 | ⬜ | |

### API接口测试
| 接口 | 状态 | 响应时间 | 备注 |
|------|------|----------|------|
| Mock登录 | ⬜ | ___ms | |
| 微信登录 | ⬜ | ___ms | |
| 更新昵称 | ⬜ | ___ms | |
| 上传头像 | ⬜ | ___ms | |

### 验证测试
| 验证项 | 状态 | 备注 |
|--------|------|------|
| 大文件拒绝 | ⬜ | |
| 错误类型拒绝 | ⬜ | |
| 数据库数据 | ⬜ | |

### 前后端联调
| 功能 | 状态 | 备注 |
|------|------|------|
| 自动登录 | ⬜ | |
| 修改昵称 | ⬜ | |
| 更换头像 | ⬜ | |

---

## 🐛 常见问题排查

### 问题1：后端启动失败

**可能原因：**
- MySQL未启动
- 数据库配置错误
- 端口8081被占用

**排查步骤：**
```bash
# 检查MySQL
mysql -u xiaohonghua -p

# 检查端口占用
lsof -i:8081

# 查看详细错误日志
cd backend
mvn spring-boot:run
```

---

### 问题2：微信登录失败

**错误1：invalid code**
- 原因：code已使用或过期
- 解决：重新获取code

**错误2：invalid appid**
- 原因：AppID配置错误
- 解决：检查application.yml配置

**错误3：code been used**
- 原因：同一个code使用了多次
- 解决：每次测试都要获取新的code

---

### 问题3：文件上传失败

**错误：创建上传目录失败**
- 检查目录是否存在
- 检查文件权限

**错误：文件保存失败**
- 检查磁盘空间
- 检查文件路径配置

---

### 问题4：前端无法连接后端

**检查项：**
1. 后端服务是否运行
2. 防火墙是否阻止
3. API地址配置是否正确

**前端配置检查：**
```javascript
// miniprogram/utils/realApi.js
const CONFIG = {
  DEV_BASE_URL: 'http://localhost:8081/api',
  ENV: 'dev'
}
```

---

## ✅ 测试完成检查清单

测试完成后，请确认以下所有项都已完成：

- [ ] 所有API接口测试通过
- [ ] 数据验证测试通过
- [ ] 数据库数据正确保存
- [ ] 前后端联调成功
- [ ] 小程序登录流程正常
- [ ] 用户信息修改功能正常
- [ ] 头像上传功能正常
- [ ] 所有错误处理正常工作
- [ ] 测试结果记录表已填写完整
- [ ] 发现的问题已记录并报告

---

## 📝 测试报告模板

测试完成后，请填写以下信息：

**测试人员：** ___________

**测试日期：** ___________

**测试环境：**
- 操作系统：___________
- Java版本：___________
- MySQL版本：___________
- 微信开发者工具版本：___________

**测试结果：**
- 通过数量：___ / 13
- 失败数量：___
- 阻塞问题：___

**发现的问题：**
1. 
2. 
3. 

**建议和改进：**
1. 
2. 
3. 

**测试结论：** ⬜ 通过 / ⬜ 不通过 / ⬜ 部分通过

---

**祝测试顺利！如有问题随时反馈。** 🚀

