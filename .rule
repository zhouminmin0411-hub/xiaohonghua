# 小红花项目开发规则和注意事项

## 1. Java版本管理

### 问题描述
本项目使用 **Java 21**，但系统中可能安装了多个Java版本（如Java 17、21、25等）。当默认Java版本不是21时，会导致以下问题：
- Maven编译失败：`Fatal error compiling: java.lang.ExceptionInInitializerError`
- Spring Boot服务无法启动

### 错误表现
```
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.13.0:compile
(default-compile) on project xiaohonghua-backend: Fatal error compiling: 
java.lang.ExceptionInInitializerError: com.sun.tools.javac.code.TypeTag
```

### 正确的解决方案 ✅

**步骤1：检查当前Java版本**
```bash
java -version
```

如果显示的不是 `openjdk version "21.0.9"`，则需要切换。

**步骤2：查看已安装的Java版本**
```bash
brew list --versions | grep openjdk
```

**步骤3：切换到Java 21**
```bash
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH
```

**步骤4：验证切换成功**
```bash
java -version
# 应该显示：openjdk version "21.0.9" ...
```

**步骤5：启动服务**
```bash
cd backend
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH
mvn spring-boot:run
```

### 永久设置（可选）
将以下内容添加到 `~/.zshrc` 或 `~/.bash_profile`：
```bash
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH
```

然后执行：
```bash
source ~/.zshrc  # 或 source ~/.bash_profile
```

### ❌ 错误的解决方案（禁止使用）

**禁止将pom.xml中的Java版本从21降级到17！**

理由：
1. 项目代码已经使用了Java 21的特性
2. 之前的成功运行证明Java 21是正确的配置
3. 降级会导致更多兼容性问题

## 2. 后端服务启动

### 端口占用问题
如果看到错误：
```
Port 8081 is already in use
```

**解决方案：**
```bash
# 查找占用端口的进程
lsof -i :8081

# 杀死进程（将PID替换为实际的进程ID）
kill -9 <PID>

# 或者重启服务
```

### 数据库连接
确保MySQL服务正在运行：
```bash
brew services list | grep mysql
```

如果未运行：
```bash
brew services start mysql
```

## 3. 前端小程序开发

### API配置
- 开发环境：`http://localhost:8081/api`
- 生产环境：需要在 `miniprogram/utils/realApi.js` 中配置

### 常见错误

**"request:fail" 错误**
原因：后端服务未启动或无法访问
解决：
1. 检查后端服务是否在8081端口运行
2. 确认Java版本正确（见第1节）
3. 测试API：`curl http://localhost:8081/api/auth/login`

## 4. 开发工作流

### 后端开发
```bash
cd backend

# 确保使用Java 21
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH

# 启动服务
mvn spring-boot:run

# 访问API文档
# http://localhost:8081/api/doc.html
```

### 前端开发
1. 确保后端服务已启动
2. 打开微信开发者工具
3. 导入项目（选择miniprogram目录）
4. 在详情中勾选"不校验合法域名"

## 5. 故障排查优先级

遇到问题时，按以下顺序排查：

1. **检查Java版本**（最常见）
   ```bash
   java -version
   ```

2. **检查后端服务状态**
   ```bash
   lsof -i :8081
   curl http://localhost:8081/api/auth/login
   ```

3. **检查数据库连接**
   ```bash
   brew services list | grep mysql
   ```

4. **查看服务日志**
   - 观察终端输出
   - 检查是否有报错信息

5. **清理并重新编译**
   ```bash
   cd backend
   mvn clean package
   mvn spring-boot:run
   ```

## 6. 重要提醒

⚠️ **在尝试修改配置文件之前，先分析问题根源！**

- 不要轻易修改pom.xml中的Java版本
- 不要修改数据库配置（除非确实需要）
- 优先检查环境问题，而不是修改代码

⚠️ **如果之前能正常运行，突然出现问题，99%是环境变化导致的！**

常见的环境变化：
- 系统升级导致Java版本切换
- 终端重启导致环境变量丢失
- 其他进程占用端口

---

**最后更新：** 2025-12-18
**维护者：** AI Assistant

