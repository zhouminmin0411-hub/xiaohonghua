<!--设置页面 · 绘本风 Refined-->
<view class="page-container">
  <!-- 顶部区域 -->
  <view class="header">
    <view class="header-title">{{isOnboarding ? '和小朋友一起开始小红花旅程' : '设置'}}</view>
  </view>

  <!-- 引导模式特有视图 -->
  <view class="onboarding-section" wx:if="{{isOnboarding}}">
    <view class="onboarding-card">
      <view class="auth-header">
        <view class="auth-subtitle">让小红花记住你们的每一次进步呀</view>
      </view>

      <view class="auth-body">
        <button 
          class="avatar-wrapper-large" 
          open-type="chooseAvatar" 
          bindchooseavatar="onChooseAvatar"
        >
          <image class="avatar-large" src="{{avatarDisplayUrl || '/assets/default-avatar.png'}}" mode="aspectFill" />
          <view class="avatar-edit-icon">📸</view>
        </button>
        <text class="input-label">点击更换可爱头像</text>

        <view class="nickname-section">
          <input 
            type="nickname" 
            class="nickname-input-large" 
            placeholder="给宝宝取个名字吧" 
            value="{{tempNickname}}"
            bindinput="onNicknameInput"
            bindblur="onNicknameBlur"
          />
          <view class="input-line"></view>
        </view>
      </view>

      <view class="onboarding-footer">
        <button 
          class="confirm-btn-large {{canFinish ? 'btn-active' : ''}}" 
          bind:tap="onFinishOnboarding"
        >
          开启旅程
        </button>
      </view>

      <!-- 完成资料后的引导：切换家长模式 -->
      <view class="parent-guide-card {{canFinish ? 'guide-show' : ''}}" bind:tap="onSwitchToParent">
        <view class="guide-content">
          <view class="guide-icon">🎯</view>
          <view class="guide-text-area">
            <view class="guide-title">第二步：添加任务</view>
            <view class="guide-desc">去家长视角，为宝宝定制第一个任务吧</view>
          </view>
          <view class="guide-arrow">👉</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 用户信息卡片 (非引导态) -->
  <view class="user-section" wx:if="{{!isOnboarding}}">
    <view class="user-card">
      <!-- 头像编辑区 -->
      <view class="avatar-edit-wrapper">
        <button 
          class="avatar-edit-btn" 
          open-type="chooseAvatar" 
          bindchooseavatar="onChooseAvatar"
        >
          <image class="avatar" src="{{avatarDisplayUrl}}" mode="aspectFit"></image>
        </button>
      </view>
      
      <!-- 用户信息编辑 -->
      <view class="user-info">
        <!-- 昵称编辑 -->
        <view class="nickname-edit-wrapper">
          <input 
            class="nickname-input" 
            type="nickname" 
            value="{{userInfo.nickname || ''}}"
            placeholder="请输入昵称" 
            bindinput="onNicknameInput"
            bindblur="onNicknameBlur"
          />
          <text class="edit-hint">✏️</text>
        </view>
        
        <view class="role-badge {{isParentMode ? 'role-parent' : 'role-child'}}">
          {{isParentMode ? '家长模式' : '小朋友模式'}}
        </view>
      </view>
    </view>
  </view>

  <!-- 设置列表 (非引导态) -->
  <view class="settings-list" wx:if="{{!isOnboarding}}">
    <!-- 引导卡片可以移动到这里，或者保留在顶部 -->
    <view class="parent-guide-card guide-show" wx:if="{{showParentGuide}}" bind:tap="onSwitchToParent">
      <view class="guide-content">
        <view class="guide-icon">🎯</view>
        <view class="guide-text-area">
          <view class="guide-title">接下来：添加任务</view>
          <view class="guide-desc">去家长视角，为宝宝定制第一个任务吧</view>
        </view>
        <view class="guide-arrow">👉</view>
      </view>
    </view>
    <view 
      class="setting-item"
      bind:tap="onSwitchToParent"
      wx:if="{{!isParentMode}}"
    >
      <view class="setting-icon">👨‍👩‍👧</view>
      <view class="setting-content">
        <text class="setting-title">切换至家长视角</text>
        <text class="setting-desc">管理任务和奖励</text>
      </view>
      <view class="setting-arrow">></view>
    </view>

    <view 
      class="setting-item"
      bind:tap="onExitParentMode"
      wx:else
    >
      <view class="setting-icon">🧸</view>
      <view class="setting-content">
        <text class="setting-title">退出家长视角</text>
        <text class="setting-desc">回到小朋友界面</text>
      </view>
      <view class="setting-arrow">></view>
    </view>

    <view class="setting-item" bind:tap="onAbout">
      <view class="setting-icon">📖</view>
      <view class="setting-content">
        <text class="setting-title">关于小红花</text>
        <text class="setting-desc">版本 1.0.0</text>
      </view>
      <view class="setting-arrow">></view>
    </view>
  </view>

  <!-- 底部导航栏 (基于 Spec 第5章) -->
  <!-- Settings is not a main tab anymore, remove tab bar -->

  <!-- 密码输入弹窗 (自定义样式) -->
  <van-popup 
    show="{{ showPasswordDialog }}" 
    bind:close="onClosePasswordDialog"
    custom-style="background: transparent;"
    closeable
  >
    <view class="password-dialog-card">
      <view class="dialog-title">输入家长密码</view>
      <view class="password-input-area">
        <view class="password-dots">
          <view 
            wx:for="{{4}}" 
            wx:key="index"
            class="password-dot {{password.length > index ? 'filled' : ''}}"
          ></view>
        </view>
      </view>
      <view class="password-keyboard">
        <view class="keyboard-row">
          <view class="key" bind:tap="onKeyPress" data-key="1">1</view>
          <view class="key" bind:tap="onKeyPress" data-key="2">2</view>
          <view class="key" bind:tap="onKeyPress" data-key="3">3</view>
        </view>
        <view class="keyboard-row">
          <view class="key" bind:tap="onKeyPress" data-key="4">4</view>
          <view class="key" bind:tap="onKeyPress" data-key="5">5</view>
          <view class="key" bind:tap="onKeyPress" data-key="6">6</view>
        </view>
        <view class="keyboard-row">
          <view class="key" bind:tap="onKeyPress" data-key="7">7</view>
          <view class="key" bind:tap="onKeyPress" data-key="8">8</view>
          <view class="key" bind:tap="onKeyPress" data-key="9">9</view>
        </view>
        <view class="keyboard-row">
          <view class="key empty"></view>
          <view class="key" bind:tap="onKeyPress" data-key="0">0</view>
          <view class="key delete" bind:tap="onDeleteKey">←</view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- Toast -->
  <van-toast id="van-toast" />
</view>

