# 🚀 云托管快速开始（5分钟上线）

## 🎯 目标
将小红花后端部署到微信云托管，让小程序可以正式访问。

---

## ⏱️ 快速流程（建议按顺序操作）

### 第 1 步：开通云托管（2分钟）

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序后台
3. 点击 **云开发** → **云托管** → **立即开通**
4. 创建环境：
   - 环境名称：`xiaohonghua-prod`
   - 地域：**上海**
   - 点击创建

---

### 第 2 步：打包后端代码（1分钟）

在终端执行：

```bash
cd /Users/xila/xiaohonghua/backend

# 设置 Java 环境
export JAVA_HOME=/opt/homebrew/opt/openjdk@21
export PATH=$JAVA_HOME/bin:$PATH

# 打包（跳过测试以加快速度）
mvn clean package -DskipTests
```

等待打包完成，会生成：`target/xiaohonghua-backend-1.0.0.jar`

---

### 第 3 步：使用开发者工具部署（最简单，推荐）

#### 方法A：通过开发者工具（图形界面，最简单）

1. **打开微信开发者工具**
   
2. **进入云托管**
   - 工具栏：云开发 → 云托管
   - 选择环境：`xiaohonghua-prod`

3. **新建服务**
   - 服务名称：`xiaohonghua-backend`
   - 点击确定

4. **上传代码**
   - 点击「上传代码」
   - 选择目录：`/Users/xila/xiaohonghua/backend`
   - 等待自动构建（3-10分钟）

5. **查看部署状态**
   - 构建成功后会自动部署
   - 等待实例启动（约1-2分钟）

---

#### 方法B：命令行部署（高级用户）

```bash
# 1. 安装云托管 CLI
npm install -g @wxcloud/cli

# 2. 登录
wxcloud login

# 3. 初始化配置
cd /Users/xila/xiaohonghua/backend
wxcloud init

# 4. 部署
wxcloud deploy
```

---

### 第 4 步：配置数据库（3分钟）

1. **开通云数据库**
   - 在云托管控制台
   - 数据库 → 开通云数据库
   - 选择：MySQL 8.0，1核2G

2. **获取数据库连接信息**
   - 复制：主机地址、用户名、密码

3. **执行 SQL 初始化脚本**

   **方式A：使用命令行**
   ```bash
   # 安装 MySQL 客户端（如果没有）
   brew install mysql-client
   
   # 连接数据库
   mysql -h <云数据库地址> -P 3306 -u <用户名> -p
   
   # 执行脚本
   source /Users/xila/xiaohonghua/backend/sql/schema.sql
   source /Users/xila/xiaohonghua/backend/sql/seed.sql
   ```

   **方式B：使用图形工具**
   - 下载 Navicat 或 DBeaver
   - 连接云数据库
   - 导入 `sql/schema.sql` 和 `sql/seed.sql`

4. **配置环境变量**
   - 云托管控制台 → 服务配置 → 环境变量
   - 添加：
     - `WECHAT_APPID` = `wxe1fef2b88d7ea01e`
     - `WECHAT_SECRET` = `b3364978955119ad09d507afe5fc6c1e`
   - 数据库相关变量（云托管会自动注入，无需手动配置）

---

### 第 5 步：获取并配置域名（2分钟）

1. **获取云托管域名**
   - 部署成功后，在云托管控制台查看
   - 格式：`https://xiaohonghua-backend-xxxxx.sh.run.tcloudbase.com`
   - **复制这个域名**

2. **配置到微信公众平台**
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 开发 → 开发管理 → 开发设置 → 服务器域名
   - 配置以下三项（都填同一个域名）：
     - request合法域名
     - uploadFile合法域名
     - downloadFile合法域名
   - 点击**保存并提交**

---

### 第 6 步：修改小程序配置（1分钟）

修改文件：`/Users/xila/xiaohonghua/miniprogram/utils/realApi.js`

```javascript
const CONFIG = {
  DEV_BASE_URL: 'http://localhost:8081/api',
  PROD_BASE_URL: 'https://xiaohonghua-backend-xxxxx.sh.run.tcloudbase.com/api',  // ← 改为云托管域名
  ENV: 'prod'  // ← 改为 prod
}
```

---

### 第 7 步：测试（2分钟）

#### 1. 测试后端接口

```bash
# 测试任务列表接口
curl https://your-domain.sh.run.tcloudbase.com/api/tasks

# 应该返回 JSON 数据
```

#### 2. 测试小程序

1. 打开微信开发者工具
2. 编译小程序
3. 测试功能：
   - ✅ 登录
   - ✅ 查看任务
   - ✅ 查看积分
   - ✅ 兑换奖品

---

## ✅ 完成！

如果以上步骤都成功，您的后端已经上线！🎉

**下一步**：
- 按照《小程序上线检查清单.md》完善小程序信息
- 上传小程序代码并提交审核

---

## 📞 遇到问题？

### 常见问题速查

| 问题 | 解决方案 |
|-----|---------|
| 构建镜像失败 | 检查 Dockerfile，查看构建日志 |
| 服务启动失败 | 查看云托管日志，检查环境变量 |
| 数据库连接失败 | 确认云数据库已开通并运行 |
| 小程序请求失败 | 检查域名是否配置到微信公众平台 |
| 接口返回 404 | 检查 context-path 是否为 `/api` |

**详细文档**：查看《微信云托管部署指南.md》

---

## 💡 提示

- **首次部署**：预计总时间 15-30 分钟
- **后续更新**：只需 5-10 分钟
- **遇到问题**：先查看云托管日志
- **费用**：小型应用约 ¥40-80/月（可缩容到 0）

---

**祝您部署顺利！** 🌸

