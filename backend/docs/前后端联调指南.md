# 小红花 - 前后端联调指南

## 一、概述

本文档指导如何将小程序前端的Mock API替换为真实后端API，并完成联调测试。

---

## 二、后端准备

### 2.1 确保后端服务正常运行

**本地开发环境：**
```bash
cd backend
mvn spring-boot:run
```

访问：http://localhost:8080/api/doc.html 确认API文档可访问

**生产环境：**
访问：https://your-domain.com/api/doc.html

### 2.2 配置跨域

后端已在`WebConfig.java`中配置了跨域支持，允许小程序域名访问。

如需修改，编辑：`backend/src/main/java/com/xiaohonghua/config/WebConfig.java`

---

## 三、前端改造

### 3.1 创建真实API工具类

在小程序中创建新文件：`miniprogram/utils/realApi.js`

```javascript
/**
 * 真实API工具类
 * 替换Mock API
 */

// 配置
const CONFIG = {
  // 本地开发环境
  DEV_BASE_URL: 'http://localhost:8080/api',
  
  // 生产环境
  PROD_BASE_URL: 'https://your-domain.com/api',
  
  // 当前环境（开发时设为'dev'，上线时改为'prod'）
  ENV: 'dev'
};

// 获取基础URL
function getBaseURL() {
  return CONFIG.ENV === 'dev' ? CONFIG.DEV_BASE_URL : CONFIG.PROD_BASE_URL;
}

// 通用请求方法
function request(url, method = 'GET', data = null) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${getBaseURL()}${url}`,
      method: method,
      data: data,
      header: {
        'Content-Type': 'application/json'
      },
      success(res) {
        if (res.statusCode === 200 && res.data.code === 200) {
          resolve(res.data.data);
        } else {
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          });
          reject(res.data);
        }
      },
      fail(err) {
        wx.showToast({
          title: '网络请求失败',
          icon: 'none'
        });
        reject(err);
      }
    });
  });
}

// ==================== 认证相关 ====================

/**
 * 用户登录
 */
function login(openid) {
  return request('/auth/login', 'POST', { openid });
}

/**
 * 验证家长密码
 */
function verifyParentPassword(userId, password) {
  return request('/auth/verify-parent-password', 'POST', { userId, password });
}

// ==================== 任务相关 ====================

/**
 * 获取任务列表
 */
function getTasks() {
  return request('/tasks', 'GET');
}

/**
 * 创建任务
 */
function createTask(taskData) {
  return request('/tasks', 'POST', taskData);
}

/**
 * 更新任务
 */
function updateTask(taskId, taskData) {
  return request(`/tasks/${taskId}`, 'PUT', taskData);
}

/**
 * 删除任务
 */
function deleteTask(taskId) {
  return request(`/tasks/${taskId}`, 'DELETE');
}

// ==================== 任务记录相关 ====================

/**
 * 领取任务
 */
function receiveTask(childId, taskId) {
  return request(`/task-records/receive?childId=${childId}&taskId=${taskId}`, 'POST');
}

/**
 * 完成任务
 */
function completeTask(recordId) {
  return request(`/task-records/complete?recordId=${recordId}`, 'POST');
}

/**
 * 获取任务记录
 */
function getTaskRecords(childId, status = null) {
  let url = `/task-records?childId=${childId}`;
  if (status) {
    url += `&status=${status}`;
  }
  return request(url, 'GET');
}

/**
 * 点赞任务记录
 */
function likeTask(recordId) {
  return request(`/task-records/${recordId}/like`, 'POST');
}

/**
 * 取消点赞
 */
function unlikeTask(recordId) {
  return request(`/task-records/${recordId}/like`, 'DELETE');
}

// ==================== 奖励相关 ====================

/**
 * 获取奖励列表
 */
function getRewards() {
  return request('/rewards', 'GET');
}

/**
 * 创建奖励
 */
function createReward(rewardData) {
  return request('/rewards', 'POST', rewardData);
}

/**
 * 更新奖励
 */
function updateReward(rewardId, rewardData) {
  return request(`/rewards/${rewardId}`, 'PUT', rewardData);
}

/**
 * 删除奖励
 */
function deleteReward(rewardId) {
  return request(`/rewards/${rewardId}`, 'DELETE');
}

// ==================== 兑换记录相关 ====================

/**
 * 兑换奖励
 */
function redeemReward(childId, rewardId) {
  return request(`/reward-records/redeem?childId=${childId}&rewardId=${rewardId}`, 'POST');
}

/**
 * 获取兑换记录
 */
function getRewardRecords(childId) {
  return request(`/reward-records?childId=${childId}`, 'GET');
}

// ==================== 积分相关 ====================

/**
 * 获取当前积分
 */
function getCurrentPoints(childId) {
  return request(`/points/current?childId=${childId}`, 'GET')
    .then(res => res.points);
}

/**
 * 获取积分历史
 */
function getPointHistory(childId) {
  return request(`/points/history?childId=${childId}`, 'GET');
}

/**
 * 调整积分
 */
function adjustPoints(childId, change, reason) {
  return request('/points/adjust', 'POST', { childId, change, reason });
}

// ==================== 每周配置相关 ====================

/**
 * 获取每周配置
 */
function getWeeklyConfig(childId) {
  return request(`/weekly-config?childId=${childId}`, 'GET');
}

/**
 * 更新每周配置
 */
function updateWeeklyConfig(childId, config) {
  return request(`/weekly-config?childId=${childId}`, 'PUT', config);
}

// 导出所有方法
module.exports = {
  // 认证
  login,
  verifyParentPassword,
  
  // 任务
  getTasks,
  createTask,
  updateTask,
  deleteTask,
  
  // 任务记录
  receiveTask,
  completeTask,
  getTaskRecords,
  likeTask,
  unlikeTask,
  
  // 奖励
  getRewards,
  createReward,
  updateReward,
  deleteReward,
  
  // 兑换记录
  redeemReward,
  getRewardRecords,
  
  // 积分
  getCurrentPoints,
  getPointHistory,
  adjustPoints,
  
  // 每周配置
  getWeeklyConfig,
  updateWeeklyConfig
};
```

### 3.2 替换前端API调用

在各页面中，将导入从`mockApi`改为`realApi`：

**修改前：**
```javascript
const mockApi = require('../../utils/mockApi');
```

**修改后：**
```javascript
const realApi = require('../../utils/realApi');
```

**示例（index.js）：**

```javascript
// const mockApi = require('../../utils/mockApi');  // 注释掉
const realApi = require('../../utils/realApi');     // 使用真实API

Page({
  data: {
    tasks: [],
    currentPoints: 0
  },

  onLoad() {
    this.loadTasks();
    this.loadPoints();
  },

  // 加载任务
  async loadTasks() {
    try {
      const tasks = await realApi.getTasks();
      this.setData({ tasks });
    } catch (error) {
      console.error('加载任务失败:', error);
    }
  },

  // 加载积分
  async loadPoints() {
    try {
      const app = getApp();
      const childId = app.globalData.userInfo.id;
      const points = await realApi.getCurrentPoints(childId);
      this.setData({ currentPoints: points });
      app.globalData.currentPoints = points;
    } catch (error) {
      console.error('加载积分失败:', error);
    }
  },

  // 领取任务
  async onReceiveTask(e) {
    const taskId = e.currentTarget.dataset.id;
    const app = getApp();
    const childId = app.globalData.userInfo.id;
    
    try {
      await realApi.receiveTask(childId, taskId);
      wx.showToast({ title: '领取成功', icon: 'success' });
      this.loadTasks();
    } catch (error) {
      console.error('领取任务失败:', error);
    }
  },

  // 完成任务
  async onCompleteTask(e) {
    const recordId = e.currentTarget.dataset.recordId;
    
    try {
      await realApi.completeTask(recordId);
      wx.showToast({ title: '完成任务', icon: 'success' });
      this.loadTasks();
      this.loadPoints();
    } catch (error) {
      console.error('完成任务失败:', error);
    }
  }
});
```

### 3.3 全局状态管理调整

修改`app.js`中的初始化逻辑：

```javascript
const realApi = require('./utils/realApi');

App({
  globalData: {
    userInfo: null,
    currentPoints: 0,
    isParentMode: false
  },

  async onLaunch() {
    // 尝试登录
    await this.login();
    
    // 加载积分
    if (this.globalData.userInfo) {
      this.loadPoints();
    }
  },

  // 登录
  async login() {
    try {
      // 实际应用中应使用wx.login获取code，然后调用后端换取openid
      // 这里简化处理，使用Mock openid
      const mockOpenid = 'mock_child_openid_001';
      const user = await realApi.login(mockOpenid);
      this.globalData.userInfo = user;
      console.log('登录成功:', user);
    } catch (error) {
      console.error('登录失败:', error);
    }
  },

  // 加载积分
  async loadPoints() {
    try {
      const points = await realApi.getCurrentPoints(this.globalData.userInfo.id);
      this.globalData.currentPoints = points;
    } catch (error) {
      console.error('加载积分失败:', error);
    }
  }
});
```

---

## 四、小程序配置

### 4.1 配置服务器域名

在微信公众平台（mp.weixin.qq.com）配置合法域名：

1. 登录微信公众平台
2. 开发 → 开发管理 → 开发设置
3. 服务器域名 → request合法域名
4. 添加：`https://your-domain.com`

**注意：**
- 必须使用HTTPS
- 本地开发时可在微信开发者工具中勾选"不校验合法域名"

### 4.2 project.config.json配置

确保配置中包含：

```json
{
  "setting": {
    "urlCheck": false
  }
}
```

---

## 五、联调测试

### 5.1 本地联调

1. 启动后端服务：
```bash
cd backend
mvn spring-boot:run
```

2. 打开微信开发者工具
3. 勾选"不校验合法域名"
4. 修改`utils/realApi.js`中的`ENV`为`'dev'`
5. 重新编译小程序
6. 测试各项功能

### 5.2 测试清单

- [ ] 登录成功
- [ ] 任务列表加载正常
- [ ] 领取任务成功
- [ ] 完成任务，积分增加
- [ ] 积分商城加载正常
- [ ] 兑换奖励，积分扣减
- [ ] 家长密码验证成功
- [ ] 家长端任务管理正常
- [ ] 家长端奖励管理正常
- [ ] 家长点赞功能正常
- [ ] 积分调整功能正常
- [ ] 每周配置保存成功

### 5.3 调试技巧

**查看网络请求：**
- 微信开发者工具 → 调试器 → Network
- 查看请求URL、参数、响应

**查看后端日志：**
```bash
tail -f /var/log/xiaohonghua/application.log
```

**常见问题：**

1. **请求失败：ERR_CONNECTION_REFUSED**
   - 检查后端服务是否启动
   - 检查端口是否正确

2. **请求失败：SSL证书错误**
   - 勾选"不校验合法域名"（仅开发环境）
   - 或配置正确的HTTPS证书

3. **返回401/403错误**
   - 检查是否需要token认证
   - 检查跨域配置

---

## 六、生产环境上线

### 6.1 修改配置

1. 修改`utils/realApi.js`：
```javascript
ENV: 'prod'  // 改为生产环境
```

2. 确保后端已部署到生产服务器

3. 确保HTTPS证书已配置

4. 在微信公众平台配置合法域名

### 6.2 体验版测试

1. 微信开发者工具 → 上传代码
2. 登录微信公众平台 → 版本管理 → 体验版
3. 生成体验版二维码
4. 扫码测试

### 6.3 提交审核

1. 微信公众平台 → 版本管理
2. 选择体验版 → 提交审核
3. 填写审核信息
4. 等待审核通过

### 6.4 发布上线

1. 审核通过后 → 版本管理
2. 点击"发布"
3. 正式上线

---

## 七、监控与维护

### 7.1 错误监控

在`realApi.js`中添加错误上报：

```javascript
function request(url, method = 'GET', data = null) {
  return new Promise((resolve, reject) => {
    wx.request({
      // ... 其他配置
      fail(err) {
        // 上报错误
        wx.reportMonitor('api_error', 1);
        
        // 记录日志
        console.error('API请求失败:', url, err);
        
        reject(err);
      }
    });
  });
}
```

### 7.2 性能监控

使用微信小程序性能监控：
- 微信公众平台 → 运维中心 → 性能监控

---

## 八、回滚方案

如果联调出现问题，可快速回滚到Mock模式：

1. 恢复导入：
```javascript
const mockApi = require('../../utils/mockApi');
// const realApi = require('../../utils/realApi');
```

2. 重新编译并上传

---

## 联调检查清单

- [ ] 后端服务已部署并正常运行
- [ ] 数据库已初始化
- [ ] Nginx已配置
- [ ] HTTPS证书已配置（生产环境）
- [ ] 跨域已配置
- [ ] realApi.js已创建
- [ ] 所有页面已替换为realApi
- [ ] 本地联调测试通过
- [ ] 生产环境域名已配置
- [ ] 体验版测试通过
- [ ] 性能正常
- [ ] 无报错
- [ ] 准备好回滚方案

---

**联调完成后，小程序即可正式上线使用！**

