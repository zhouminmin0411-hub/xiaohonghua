# 小红花后端 - 阿里云ECS部署指南

## 一、准备工作

### 1.1 购买阿里云ECS

**推荐配置：**
- 实例规格：2核4GB（ecs.t6-c1m2.large）
- 操作系统：CentOS 7.9 或 Alibaba Cloud Linux 3
- 磁盘：40GB系统盘
- 地域：选择离用户较近的区域

### 1.2 配置安全组

登录阿里云控制台，为ECS配置安全组规则：

| 规则方向 | 授权策略 | 协议类型 | 端口范围 | 授权对象 | 描述 |
|---------|---------|---------|---------|---------|------|
| 入方向 | 允许 | TCP | 22/22 | 0.0.0.0/0 | SSH远程登录 |
| 入方向 | 允许 | TCP | 80/80 | 0.0.0.0/0 | HTTP |
| 入方向 | 允许 | TCP | 443/443 | 0.0.0.0/0 | HTTPS |
| 入方向 | 允许 | TCP | 8080/8080 | 0.0.0.0/0 | Spring Boot应用 |
| 入方向 | 允许 | TCP | 3306/3306 | 内网IP | MySQL（仅内网） |

---

## 二、服务器环境配置

### 2.1 连接服务器

```bash
ssh root@your-server-ip
```

### 2.2 安装JDK 17

```bash
# 下载并安装OpenJDK 17
yum install -y java-17-openjdk java-17-openjdk-devel

# 验证安装
java -version
# 应显示：openjdk version "17.x.x"
```

### 2.3 安装MySQL 8.0

```bash
# 下载MySQL YUM仓库
wget https://dev.mysql.com/get/mysql80-community-release-el7-7.noarch.rpm

# 安装YUM仓库
rpm -ivh mysql80-community-release-el7-7.noarch.rpm

# 安装MySQL服务器
yum install -y mysql-community-server

# 启动MySQL
systemctl start mysqld
systemctl enable mysqld

# 获取临时密码
grep 'temporary password' /var/log/mysqld.log

# 登录并修改root密码
mysql -u root -p
# 输入临时密码

# 修改密码（请替换为强密码）
ALTER USER 'root'@'localhost' IDENTIFIED BY 'YourStrongPassword123!';

# 创建数据库
CREATE DATABASE xiaohonghua DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建应用用户
CREATE USER 'xiaohonghua_app'@'localhost' IDENTIFIED BY 'AppPassword123!';
GRANT ALL PRIVILEGES ON xiaohonghua.* TO 'xiaohonghua_app'@'localhost';
FLUSH PRIVILEGES;

EXIT;
```

### 2.4 导入数据库脚本

```bash
# 上传SQL脚本到服务器
scp -r sql/ root@your-server-ip:/root/

# 导入建表脚本
mysql -u root -p xiaohonghua < /root/sql/schema.sql

# 导入种子数据
mysql -u root -p xiaohonghua < /root/sql/seed.sql
```

### 2.5 安装Nginx

```bash
# 安装Nginx
yum install -y nginx

# 启动Nginx
systemctl start nginx
systemctl enable nginx
```

---

## 三、部署Spring Boot应用

### 3.1 本地打包

在本地开发机器上：

```bash
cd backend

# 打包（跳过测试）
mvn clean package -Dmaven.test.skip=true

# 打包成功后，在target目录下生成：
# xiaohonghua-backend-1.0.0.jar
```

### 3.2 上传到服务器

```bash
# 创建应用目录
ssh root@your-server-ip
mkdir -p /opt/xiaohonghua

# 退出SSH，上传jar包
scp target/xiaohonghua-backend-1.0.0.jar root@your-server-ip:/opt/xiaohonghua/
```

### 3.3 创建生产环境配置

在服务器上创建配置文件：

```bash
cd /opt/xiaohonghua

# 创建application-prod.yml
cat > application-prod.yml << 'EOF'
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/xiaohonghua?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: xiaohonghua_app
    password: AppPassword123!
    hikari:
      maximum-pool-size: 20
      minimum-idle: 10

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

logging:
  level:
    root: INFO
    com.xiaohonghua: INFO
  file:
    name: /var/log/xiaohonghua/application.log
    max-size: 10MB
    max-history: 30

knife4j:
  enable: false
EOF

# 创建日志目录
mkdir -p /var/log/xiaohonghua
```

### 3.4 创建启动脚本

```bash
cat > /opt/xiaohonghua/start.sh << 'EOF'
#!/bin/bash

APP_NAME=xiaohonghua-backend-1.0.0.jar
APP_HOME=/opt/xiaohonghua

cd $APP_HOME

# 检查是否已运行
PID=$(ps -ef | grep $APP_NAME | grep -v grep | awk '{print $2}')
if [ -n "$PID" ]; then
    echo "应用已在运行，PID: $PID"
    exit 1
fi

# 启动应用
nohup java -jar \
    -Xms512m -Xmx1024m \
    -Dspring.profiles.active=prod \
    $APP_NAME \
    > /var/log/xiaohonghua/console.log 2>&1 &

echo "应用启动中..."
sleep 3

# 验证启动
PID=$(ps -ef | grep $APP_NAME | grep -v grep | awk '{print $2}')
if [ -n "$PID" ]; then
    echo "应用启动成功，PID: $PID"
else
    echo "应用启动失败，请查看日志"
    exit 1
fi
EOF

chmod +x start.sh
```

### 3.5 创建停止脚本

```bash
cat > /opt/xiaohonghua/stop.sh << 'EOF'
#!/bin/bash

APP_NAME=xiaohonghua-backend-1.0.0.jar

PID=$(ps -ef | grep $APP_NAME | grep -v grep | awk '{print $2}')

if [ -z "$PID" ]; then
    echo "应用未运行"
    exit 1
fi

echo "正在停止应用，PID: $PID"
kill $PID

# 等待进程结束
sleep 3

PID=$(ps -ef | grep $APP_NAME | grep -v grep | awk '{print $2}')
if [ -z "$PID" ]; then
    echo "应用已停止"
else
    echo "应用未能正常停止，强制终止"
    kill -9 $PID
fi
EOF

chmod +x stop.sh
```

### 3.6 创建重启脚本

```bash
cat > /opt/xiaohonghua/restart.sh << 'EOF'
#!/bin/bash

./stop.sh
sleep 2
./start.sh
EOF

chmod +x restart.sh
```

### 3.7 启动应用

```bash
cd /opt/xiaohonghua
./start.sh

# 查看日志
tail -f /var/log/xiaohonghua/console.log
```

---

## 四、配置Nginx反向代理

### 4.1 创建Nginx配置

```bash
cat > /etc/nginx/conf.d/xiaohonghua.conf << 'EOF'
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名

    # API接口代理
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 跨域配置
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization';
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # 日志
    access_log /var/log/nginx/xiaohonghua_access.log;
    error_log /var/log/nginx/xiaohonghua_error.log;
}
EOF

# 测试配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

### 4.2 配置HTTPS（可选但推荐）

**使用Let's Encrypt免费证书：**

```bash
# 安装certbot
yum install -y certbot python3-certbot-nginx

# 申请证书
certbot --nginx -d your-domain.com

# 自动续期
echo "0 0,12 * * * root python3 -c 'import random; import time; time.sleep(random.random() * 3600)' && certbot renew -q" | sudo tee -a /etc/crontab > /dev/null
```

---

## 五、配置系统服务（可选）

### 5.1 创建Systemd服务

```bash
cat > /etc/systemd/system/xiaohonghua.service << 'EOF'
[Unit]
Description=Xiaohonghua Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/xiaohonghua
ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m -Dspring.profiles.active=prod /opt/xiaohonghua/xiaohonghua-backend-1.0.0.jar
Restart=on-failure
RestartSec=10
StandardOutput=append:/var/log/xiaohonghua/console.log
StandardError=append:/var/log/xiaohonghua/console.log

[Install]
WantedBy=multi-user.target
EOF

# 重载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start xiaohonghua

# 设置开机自启
systemctl enable xiaohonghua

# 查看状态
systemctl status xiaohonghua
```

### 5.2 使用systemctl管理

```bash
# 启动
systemctl start xiaohonghua

# 停止
systemctl stop xiaohonghua

# 重启
systemctl restart xiaohonghua

# 查看状态
systemctl status xiaohonghua

# 查看日志
journalctl -u xiaohonghua -f
```

---

## 六、监控与维护

### 6.1 日志查看

```bash
# 应用日志
tail -f /var/log/xiaohonghua/application.log

# 控制台日志
tail -f /var/log/xiaohonghua/console.log

# Nginx日志
tail -f /var/log/nginx/xiaohonghua_access.log
tail -f /var/log/nginx/xiaohonghua_error.log
```

### 6.2 性能监控

```bash
# 查看Java进程
jps -l

# 查看JVM内存
jmap -heap <pid>

# 查看线程
jstack <pid>

# 系统资源
top
htop
free -h
df -h
```

### 6.3 数据库备份

```bash
# 创建备份脚本
cat > /root/backup_mysql.sh << 'EOF'
#!/bin/bash

BACKUP_DIR=/data/backup/mysql
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

mysqldump -u root -p'YourPassword' xiaohonghua > $BACKUP_DIR/xiaohonghua_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
EOF

chmod +x /root/backup_mysql.sh

# 添加定时任务（每天凌晨2点备份）
echo "0 2 * * * /root/backup_mysql.sh" | crontab -
```

---

## 七、故障排查

### 7.1 应用无法启动

```bash
# 查看日志
tail -100 /var/log/xiaohonghua/console.log

# 检查端口占用
netstat -nltp | grep 8080

# 检查Java进程
ps aux | grep java
```

### 7.2 数据库连接失败

```bash
# 测试数据库连接
mysql -u xiaohonghua_app -p xiaohonghua

# 查看MySQL状态
systemctl status mysqld

# 查看MySQL日志
tail -f /var/log/mysqld.log
```

### 7.3 Nginx报错

```bash
# 测试配置
nginx -t

# 查看错误日志
tail -f /var/log/nginx/error.log

# 检查端口
netstat -nltp | grep 80
```

---

## 八、更新部署

### 8.1 更新应用

```bash
# 1. 上传新版本jar包
scp target/xiaohonghua-backend-1.0.0.jar root@your-server-ip:/opt/xiaohonghua/

# 2. 重启应用
ssh root@your-server-ip
cd /opt/xiaohonghua
./restart.sh

# 3. 验证
curl http://localhost:8080/api/doc.html
```

### 8.2 数据库迁移

如需更新数据库结构：

```bash
# 1. 备份数据
mysqldump -u root -p xiaohonghua > backup_before_migration.sql

# 2. 执行迁移SQL
mysql -u root -p xiaohonghua < migration.sql

# 3. 验证
mysql -u root -p xiaohonghua -e "SHOW TABLES;"
```

---

## 九、安全加固

### 9.1 防火墙配置

```bash
# 启用firewalld
systemctl start firewalld
systemctl enable firewalld

# 开放必要端口
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-port=22/tcp

# 重载配置
firewall-cmd --reload
```

### 9.2 SSH加固

```bash
# 修改SSH端口
vi /etc/ssh/sshd_config
# Port 22 改为 Port 2222

# 禁止root密码登录（配置密钥后）
# PermitRootLogin prohibit-password

# 重启SSH
systemctl restart sshd
```

---

## 十、部署检查清单

- [ ] ECS实例已购买并配置安全组
- [ ] JDK 17已安装
- [ ] MySQL 8.0已安装并初始化数据库
- [ ] 数据库表已创建
- [ ] 种子数据已导入
- [ ] Spring Boot应用已打包
- [ ] jar包已上传到服务器
- [ ] 生产环境配置已创建
- [ ] 应用已启动成功
- [ ] Nginx已安装并配置
- [ ] HTTPS证书已配置（可选）
- [ ] 系统服务已配置（可选）
- [ ] 日志目录已创建
- [ ] 定时备份已配置
- [ ] 防火墙已配置
- [ ] API可正常访问
- [ ] 小程序可成功调用后端接口

---

**部署完成后，请访问 http://your-domain.com/api/doc.html 验证部署成功！**

