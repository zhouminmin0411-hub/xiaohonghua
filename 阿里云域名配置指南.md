# 阿里云域名配置指南 - 小红花项目

## 📋 目标
将 `amyworkshop.com` 的子域名 `api.amyworkshop.com` 绑定到微信云托管

---

## 🎯 操作步骤

### 步骤1：登录阿里云域名控制台

1. **访问阿里云控制台**
   - 地址：https://dns.console.aliyun.com/
   - 登录您的阿里云账号

2. **找到域名**
   - 在域名列表中找到 `amyworkshop.com`
   - 点击 **解析** 或 **解析设置**

---

### 步骤2：添加CNAME解析记录

在解析设置页面，点击 **添加记录**，填写以下信息：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **记录类型** | CNAME | 选择 CNAME |
| **主机记录** | api | 即 api.amyworkshop.com |
| **解析线路** | 默认 | 不用改 |
| **记录值** | [从云托管复制的CNAME] | 类似 xiaohonghua-backend-xxxxx.sh.run.tcloudbase.com |
| **TTL** | 10分钟 | 或保持默认 600 |

**示例：**
```
记录类型：CNAME
主机记录：api
记录值：xiaohonghua-backend-210662-7-1385129541.sh.run.tcloudbase.com
TTL：600（10分钟）
```

**截图示意：**
```
┌─────────────────────────────────────────────┐
│ 记录类型：[CNAME ▼]                          │
│ 主机记录：[api        ]                      │
│ 解析线路：[默认 ▼]                           │
│ 记录值：  [xiaohonghua-backend-xxxxx...]     │
│ TTL：     [600 ▼]                           │
│                                              │
│        [取消]  [确定]                        │
└─────────────────────────────────────────────┘
```

---

### 步骤3：等待DNS解析生效

**时间：** 通常5-10分钟，最多30分钟

**检查方法：**

在终端执行：
```bash
# 检查DNS解析是否生效
nslookup api.amyworkshop.com

# 应该看到类似输出：
# api.amyworkshop.com  canonical name = xiaohonghua-backend-xxxxx.sh.run.tcloudbase.com
```

或使用在线工具：
- https://tool.chinaz.com/dns/

---

### 步骤4：等待SSL证书签发

DNS解析生效后：

1. **云托管自动签发SSL证书**
   - 时间：5-30分钟
   - 无需手动操作

2. **查看证书状态**
   - 在云托管控制台 → 自定义域名
   - 状态显示为 **已启用** 即可

3. **测试HTTPS访问**
   ```bash
   # 测试域名是否可访问
   curl https://api.amyworkshop.com/api/tasks
   ```

---

### 步骤5：配置到微信公众平台

1. **登录微信公众平台**
   - 地址：https://mp.weixin.qq.com/

2. **配置服务器域名**
   - 路径：开发 → 开发管理 → 开发设置 → 服务器域名
   - 点击 **修改**

3. **填写三个域名**（都填同一个）：

   ```
   request合法域名：
   api.amyworkshop.com
   
   uploadFile合法域名：
   api.amyworkshop.com
   
   downloadFile合法域名：
   api.amyworkshop.com
   ```

   ⚠️ **注意：** 
   - 不要加 `https://` 前缀
   - 不要加 `/api` 后缀
   - 只填写纯域名

4. **保存并提交**

---

## ✅ 完成后测试

### 1. 测试后端接口

```bash
# 测试任务列表接口
curl https://api.amyworkshop.com/api/tasks

# 应该返回JSON数据（可能是空数组或错误，因为数据库可能还没配置）
```

### 2. 测试小程序

1. 打开微信开发者工具
2. 编译小程序
3. 查看控制台是否有网络请求
4. 测试登录、任务等功能

---

## ⚠️ 常见问题

### 问题1：DNS解析不生效

**原因：** DNS缓存或解析未生效

**解决：**
```bash
# Mac清除DNS缓存
sudo dscacheutil -flushcache

# 再次检查
nslookup api.amyworkshop.com
```

### 问题2：SSL证书签发失败

**原因：** DNS解析未生效或域名未备案

**解决：**
1. 确认DNS解析已生效
2. 确认域名已ICP备案
3. 等待30分钟后重试

### 问题3：微信公众平台提示域名不合法

**可能原因：**
- 域名未备案
- 域名格式错误（不要加https://）
- 域名解析未生效

**解决：**
- 只填写纯域名：`api.amyworkshop.com`
- 确认域名已备案

---

## 📊 配置总结

### 最终配置：

| 项目 | 配置值 |
|-----|--------|
| **原始云托管域名** | `https://xiaohonghua-backend-210662-7-1385129541.sh.run.tcloudbase.com` |
| **自定义域名** | `https://api.amyworkshop.com` |
| **阿里云DNS记录** | `api.amyworkshop.com` CNAME → 云托管域名 |
| **微信服务器域名** | `api.amyworkshop.com` |
| **小程序API地址** | `https://api.amyworkshop.com/api` |

### 优势：

✅ 专业的品牌域名  
✅ 自动HTTPS（云托管提供）  
✅ 可在微信公众平台配置  
✅ 长期稳定可用  

---

## 🎯 下一步

配置完成后：

1. ✅ 开通并初始化云数据库
2. ✅ 配置环境变量
3. ✅ 测试所有功能
4. ✅ 提交小程序审核

---

**预计配置时间：** 30分钟 - 1小时（包括DNS生效和证书签发）

**如遇问题，随时查看本文档或咨询！** 🌸

